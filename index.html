<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£èªªèµ°å°±èµ° - é€±æœ«æŠ—æ‡¶æ•£ç¥å™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", "SF Pro TC", sans-serif; background: #f0f2f5; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 20px;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0) 100%);
            z-index: 1000; pointer-events: none;
        }
        .app-title { font-size: 1.2rem; font-weight: 900; color: #333; text-shadow: 0 2px 4px rgba(255,255,255,0.8); }

        /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
        .bottom-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
            z-index: 1000; padding: 20px; box-sizing: border-box;
            transition: transform 0.3s ease;
        }

        /* äº¤é€šå·¥å…·é¸æ“‡å™¨ */
        .transport-selector {
            display: flex; justify-content: space-between; margin-bottom: 20px;
            overflow-x: auto; padding-bottom: 5px; gap: 10px;
        }
        .transport-btn {
            flex: 1; min-width: 60px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px 5px; border-radius: 12px;
            background: #f4f6f8; border: 2px solid transparent;
            cursor: pointer; transition: all 0.2s;
        }
        .transport-btn i { font-size: 1.2rem; margin-bottom: 5px; color: #666; }
        .transport-btn span { font-size: 0.75rem; font-weight: bold; color: #888; }
        
        /* é¸ä¸­ç‹€æ…‹ */
        .transport-btn.active {
            background: #e3f2fd; border-color: #4285f4; transform: translateY(-2px);
        }
        .transport-btn.active i, .transport-btn.active span { color: #4285f4; }

        /* ä¸»æŒ‰éˆ• */
        .main-btn {
            width: 100%; padding: 16px; border: none; border-radius: 16px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white; font-size: 1.1rem; font-weight: 800;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            cursor: pointer; transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .main-btn:active { transform: scale(0.96); }

        /* --- ä»»å‹™å¡ç‰‡ (å½ˆçª—) --- */
        #mission-card {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 85%; max-width: 360px;
            background: white; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 2000; padding: 0; overflow: hidden;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #mission-card.show { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }

        .card-header {
            background: #4285f4; color: white; padding: 15px 20px;
            font-weight: bold; font-size: 0.9rem; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-body { padding: 25px 20px; text-align: center; }
        
        .mission-tag {
            display: inline-block; padding: 5px 12px; border-radius: 20px;
            background: #eef4ff; color: #4285f4; font-size: 0.8rem; font-weight: bold;
            margin-bottom: 15px;
        }
        .mission-title { font-size: 1.5rem; font-weight: 900; color: #333; margin-bottom: 10px; line-height: 1.3; }
        .mission-desc { font-size: 0.95rem; color: #666; margin-bottom: 25px; line-height: 1.6; }
        
        .card-footer {
            padding: 20px; border-top: 1px solid #f0f0f0;
            display: flex; gap: 10px;
        }
        .btn-action {
            flex: 1; padding: 12px; border-radius: 10px; border: none;
            font-weight: bold; cursor: pointer; text-decoration: none;
            display: flex; align-items: center; justify-content: center; font-size: 0.9rem;
        }
        .btn-outline { background: #f5f5f5; color: #666; }
        .btn-primary { background: #4285f4; color: white; }

        /* å®šä½æŒ‰éˆ• */
        .locate-btn {
            position: absolute; bottom: 240px; right: 20px;
            width: 45px; height: 45px; background: white; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 900; color: #333;
        }

        /* Loading */
        .loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top:15px; font-weight:bold; color:#555;">æ­£åœ¨å°‹æ‰¾æ‚¨çš„ä½ç½®...</p>
    </div>

    <div class="top-bar">
        <div class="app-title">ğŸ‡¹ğŸ‡¼ é€±æœ«æŠ—æ‡¶æ•£ç¥å™¨</div>
    </div>

    <div id="map"></div>

    <div class="locate-btn" onclick="getCurrentLocation()">
        <i class="fas fa-crosshairs"></i>
    </div>

    <div class="bottom-panel">
        <div style="margin-bottom:10px; font-size:0.9rem; font-weight:bold; color:#555;">ä»Šå¤©æ€éº¼å»ï¼Ÿ</div>
        <div class="transport-selector">
            <div class="transport-btn" onclick="selectMode('walk', 1.0)">
                <i class="fas fa-walking"></i>
                <span>æ­¥è¡Œ</span>
            </div>
            <div class="transport-btn" onclick="selectMode('bike', 5.0)">
                <i class="fas fa-bicycle"></i>
                <span>å–®è»Š</span>
            </div>
            <div class="transport-btn active" onclick="selectMode('scooter', 15.0)">
                <i class="fas fa-motorcycle"></i>
                <span>æ©Ÿè»Š</span>
            </div>
            <div class="transport-btn" onclick="selectMode('transit', 10.0)">
                <i class="fas fa-train"></i>
                <span>å¤§çœ¾é‹è¼¸</span>
            </div>
            <div class="transport-btn" onclick="selectMode('car', 40.0)">
                <i class="fas fa-car"></i>
                <span>é–‹è»Š</span>
            </div>
        </div>

        <button class="main-btn" onclick="generateMission()">
            <i class="fas fa-dice"></i> çµ¦æˆ‘ä¸€å€‹ä»»å‹™ï¼
        </button>
    </div>

    <div id="mission-card">
        <div class="card-header">
            <span>MISSION #<span id="mission-id">001</span></span>
            <i class="fas fa-times" onclick="closeCard()" style="cursor:pointer"></i>
        </div>
        <div class="card-body">
            <div class="mission-tag" id="mission-type">â˜• æ–‡é’é™å®š</div>
            <div class="mission-title" id="mission-text">å»å°‹æ‰¾å··å¼„è£¡çš„è€å®…å’–å•¡</div>
            <div class="mission-desc" id="mission-detail">
                ç›®æ¨™è·é›¢ä½  <span id="mission-dist">1.2</span> kmã€‚<br>
                æŠµé”å¾Œï¼Œè«‹é»ä¸€æ¯æ²’å–éçš„é£²æ–™ï¼Œä¸¦ç™¼ä¸€å‰‡é™æ™‚å‹•æ…‹ã€‚
            </div>
        </div>
        <div class="card-footer">
            <button class="btn-action btn-outline" onclick="generateMission()">å†æŠ½ä¸€æ¬¡</button>
            <a id="gmap-link" href="#" target="_blank" class="btn-action btn-primary">
                <i class="fas fa-map-marker-alt" style="margin-right:5px"></i> å°èˆªå‡ºç™¼
            </a>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. è³‡æ–™åº«ï¼šä»»å‹™æ¨¡ç‰ˆ (æ··åˆç”Ÿæˆ) ---
        // {types}: å°‡æœƒè¢«æ›¿æ›æˆå…·é«”çš„åœ°é»é¡å‹
        // {action}: å…·é«”çš„æŒ‡ä»¤
        const missions = [
            { type: "ç¾é£Ÿå¤§å†’éšª", text: "å» {dist}km é™„è¿‘çš„å¤œå¸‚/å°åƒæ”¤", detail: "éš¨æ©Ÿæ‰¾ä¸€å®¶ã€Œæ’éšŠè¶…é 5 äººã€ä½†ä½ æ²’åƒéçš„æ”¤ä½ï¼ŒæŒ‘æˆ°è€é—†çš„æ‹›ç‰Œèœï¼" },
            { type: "è€æ´¾æµªæ¼«", text: "å°‹æ‰¾ {dist}km å…§çš„è€å®…å’–å•¡", detail: "å¸¶ä¸Šä¸€æœ¬æ›¸æˆ–ç­†è¨˜æœ¬ï¼Œåœ¨é‚£è£¡å¾…æ»¿ 1 å°æ™‚ï¼Œä¸å‡†æ»‘æ‰‹æ©Ÿã€‚" },
            { type: "æ¥µé™æ”¾ç©º", text: "å‰å¾€ {dist}km è™•çš„å…¬åœ’/æ°´å²¸", detail: "æ‰¾å¼µé•·æ¤…åä¸‹ï¼Œç™¼å‘† 20 åˆ†é˜ï¼Œè§€å¯Ÿ 3 å€‹è·¯äººçš„ç©¿æ­ã€‚" },
            { type: "åŸå¸‚æ¢éšª", text: "æ¢ç´¢ {dist}km å¤–çš„ä¸€å€‹é™Œç”Ÿè¡—å€", detail: "éš¨æ„èµ°é€²ä¸€æ¢æ²’èµ°éçš„å··å­ï¼Œç›´åˆ°çœ‹è¦‹ä¸€éš»è²“æˆ–ä¾¿åˆ©å•†åº—ç‚ºæ­¢ã€‚" },
            { type: "æ–‡è—é’å¹´", text: "å» {dist}km é™„è¿‘çš„æ›¸åº—/åœ–æ›¸é¤¨", detail: "é–‰è‘—çœ¼ç›éš¨æ©ŸæŠ½ä¸€æœ¬æ›¸ï¼Œé–±è®€ç¬¬ 20 é çš„ç¬¬ä¸€å¥è©±ã€‚" },
            { type: "å¾®é†ºæ™‚åˆ»", text: "å°‹æ‰¾ {dist}km å…§çš„å±…é…’å±‹/ç†±ç‚’", detail: "é»ä¸€æ¯æ²’å–éçš„é£²æ–™ï¼Œä¸¦æ‹ä¸‹ä¹¾æ¯çš„ç…§ç‰‡ã€‚" },
            { type: "è§€å…‰å®¢æ¨¡å¼", text: "å» {dist}km é™„è¿‘è©•åƒ¹æœ€é«˜çš„æ™¯é»", detail: "å‡è£è‡ªå·±æ˜¯ç¬¬ä¸€æ¬¡ä¾†é€™è£¡çš„è§€å…‰å®¢ï¼Œä¸¦æ‰¾è·¯äººå¹«ä½ æ‹å¼µç…§ã€‚" },
            { type: "ä¾¿åˆ©å•†åº—å†’éšª", text: "å» {dist}km å¤–çš„ä¾¿åˆ©å•†åº—", detail: "è²·ä¸€æ¨£ä½ å¾ä¾†æ²’è²·éçš„é›¶é£Ÿæˆ–é£²æ–™ï¼Œååœ¨åº—å…§æŠŠå®ƒåƒå®Œã€‚" }
        ];

        // --- 2. ç³»çµ±è®Šæ•¸ ---
        let map, userMarker, targetMarker, routeLine, rangeCircle;
        let currentLat, currentLng;
        let selectedRadius = 15.0; // é è¨­æ©Ÿè»Š 15km
        let currentMode = 'scooter';

        // åˆå§‹åŒ–
        window.onload = function() {
            initMap();
            getCurrentLocation();
        };

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([23.5, 121.0], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ''
            }).addTo(map);
        }

        // --- 3. æ ¸å¿ƒåŠŸèƒ½ï¼šå®šä½ ---
        function getCurrentLocation() {
            const loading = document.getElementById('loading');
            loading.style.opacity = 1;
            loading.style.display = 'flex';

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLat = position.coords.latitude;
                        currentLng = position.coords.longitude;
                        
                        updateUserLocation(currentLat, currentLng);
                        
                        // éš±è— Loading
                        loading.style.opacity = 0;
                        setTimeout(() => { loading.style.display = 'none'; }, 500);
                    },
                    (error) => {
                        alert("ç„¡æ³•ç²å–ä½ç½®ï¼Œå°‡é è¨­ç‚ºå°åŒ—è»Šç«™ã€‚è«‹ç¢ºä¿å·²é–‹å•Ÿå®šä½æ¬Šé™ã€‚");
                        currentLat = 25.0478;
                        currentLng = 121.5170;
                        updateUserLocation(currentLat, currentLng);
                        loading.style.display = 'none';
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚");
                loading.style.display = 'none';
            }
        }

        function updateUserLocation(lat, lng) {
            if (userMarker) map.removeLayer(userMarker);
            
            // ä½¿ç”¨è—è‰²åœ“é»ä»£è¡¨ä½¿ç”¨è€…
            userMarker = L.circleMarker([lat, lng], {
                radius: 8, fillColor: '#4285f4', color: '#fff', weight: 2, fillOpacity: 1
            }).addTo(map);

            updateRangeCircle();
            map.setView([lat, lng], 13);
        }

        // --- 4. äº¤é€šå·¥å…·åˆ‡æ› ---
        window.selectMode = function(mode, radius) {
            // æ›´æ–° UI
            document.querySelectorAll('.transport-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            selectedRadius = radius;
            currentMode = mode;
            updateRangeCircle();
        }

        function updateRangeCircle() {
            if (!currentLat) return;
            if (rangeCircle) map.removeLayer(rangeCircle);
            
            rangeCircle = L.circle([currentLat, currentLng], {
                radius: selectedRadius * 1000,
                color: '#4285f4', fillColor: '#4285f4', fillOpacity: 0.05, weight: 1, dashArray: '5, 5'
            }).addTo(map);
            
            // è‡ªå‹•ç¸®æ”¾è¦–é‡ä»¥åŒ…å«åœ“åœˆ
            map.fitBounds(rangeCircle.getBounds());
        }

        // --- 5. ä»»å‹™ç”Ÿæˆé‚è¼¯ ---
        window.generateMission = function() {
            if (!currentLat) { alert("è«‹å…ˆå®Œæˆå®šä½ï¼"); return; }

            // 1. éš¨æ©Ÿè¨ˆç®—è·é›¢èˆ‡è§’åº¦ (åœ¨åŠå¾‘å…§ï¼Œä½†ä¸è¦å¤ªè¿‘)
            const minRatio = 0.3; // è‡³å°‘è¦åœ¨åŠå¾‘çš„ 30% ä»¥å¤– (é¿å…èµ°è·¯ 10 å…¬å°ºå°±åˆ°äº†)
            const r = (selectedRadius * minRatio) + (Math.random() * selectedRadius * (1 - minRatio));
            const theta = Math.random() * 2 * Math.PI;
            
            // ç°¡æ˜“ç¶“ç·¯åº¦æ¨ç®— (ä¸éœ€æ¥µé«˜ç²¾æº–åº¦)
            const dx = r * Math.cos(theta); // km
            const dy = r * Math.sin(theta); // km
            
            // 1 deg lat ~= 110.574 km
            // 1 deg lng ~= 111.320 * cos(lat) km
            const deltaLat = dy / 110.574;
            const deltaLng = dx / (111.320 * Math.cos(currentLat * Math.PI / 180));
            
            const targetLat = currentLat + deltaLat;
            const targetLng = currentLng + deltaLng;

            // 2. éš¨æ©ŸæŒ‘é¸ä»»å‹™æ–‡æœ¬
            const missionTemplate = missions[Math.floor(Math.random() * missions.length)];
            
            // 3. é¡¯ç¤ºçµæœ
            showResult(targetLat, targetLng, r.toFixed(1), missionTemplate);
        }

        function showResult(lat, lng, dist, template) {
            // æ¸…é™¤èˆŠæ¨™è¨˜
            if (targetMarker) map.removeLayer(targetMarker);
            if (routeLine) map.removeLayer(routeLine);

            // 1. åœ¨åœ°åœ–ä¸Šæ¨™ç¤º
            const redIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            targetMarker = L.marker([lat, lng], {icon: redIcon}).addTo(map);
            
            // ç•«ç·š
            routeLine = L.polyline([[currentLat, currentLng], [lat, lng]], {
                color: '#ff6b6b', weight: 4, dashArray: '10, 10', opacity: 0.8
            }).addTo(map);

            // ç¸®æ”¾åœ°åœ–
            map.fitBounds(routeLine.getBounds().pad(0.2));

            // 2. å¡«å¯«å¡ç‰‡å…§å®¹
            const card = document.getElementById('mission-card');
            document.getElementById('mission-id').innerText = Math.floor(Math.random() * 900 + 100);
            document.getElementById('mission-type').innerText = "ğŸ“Œ " + template.type;
            
            // æ›¿æ›æ–‡æœ¬è®Šæ•¸
            document.getElementById('mission-text').innerText = template.text.replace('{dist}', dist);
            document.getElementById('mission-detail').innerHTML = template.detail + `<br><br>ç›®æ¨™ä½ç½®ï¼šè·é›¢ç´„ ${dist} å…¬é‡Œ`;

            // è¨­å®š Google Maps é€£çµ (é€™è£¡ä½¿ç”¨ "search" æ¨¡å¼ï¼Œæœå°‹é™„è¿‘çš„ç›¸é—œåœ°é»)
            // æŠ€å·§ï¼šæˆ‘å€‘ä¸å°èˆªåˆ°ç²¾ç¢ºçš„ lat/lng (å› ç‚ºé‚£å¯èƒ½æ˜¯è·¯é‚Š)ï¼Œè€Œæ˜¯å°èˆªåˆ°é‚£å€‹åº§æ¨™ï¼Œä¸¦å¸¶å…¥é—œéµå­—æœå°‹
            // ä¾‹å¦‚ï¼šæœå°‹è©²åº§æ¨™é™„è¿‘çš„ "Coffee"
            
            let keyword = "";
            if (template.type.includes("å’–å•¡")) keyword = "å’–å•¡";
            else if (template.type.includes("ç¾é£Ÿ") || template.type.includes("å¾®é†º")) keyword = "é¤å»³";
            else if (template.type.includes("æ›¸åº—")) keyword = "æ›¸åº—";
            else if (template.type.includes("ä¾¿åˆ©å•†åº—")) keyword = "ä¾¿åˆ©å•†åº—";
            else keyword = "æ™¯é»";

            // é€£çµæ ¼å¼ï¼šä½¿ç”¨ Google Maps æœå°‹è©²åº§æ¨™é™„è¿‘çš„é—œéµå­—
            // å¦‚æœæ˜¯å¤§çœ¾é‹è¼¸ï¼Œtravelmode=transit
            let travelMode = 'driving';
            if (currentMode === 'walk') travelMode = 'walking';
            if (currentMode === 'transit') travelMode = 'transit';
            if (currentMode === 'bike') travelMode = 'bicycling';

            // é€™è£¡æˆ‘å€‘ç›´æ¥å°èˆªåˆ°åº§æ¨™ï¼Œè®“ä½¿ç”¨è€…åˆ°äº†å†æ‰¾åº—ï¼Œæ¯”è¼ƒç¬¦åˆã€Œæ¢éšªã€ç²¾ç¥
            const gmapUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=${travelMode}`;
            
            document.getElementById('gmap-link').href = gmapUrl;

            // é¡¯ç¤ºå¡ç‰‡
            card.classList.add('show');
        }

        window.closeCard = function() {
            document.getElementById('mission-card').classList.remove('show');
        }
    </script>
</body>
</html>
