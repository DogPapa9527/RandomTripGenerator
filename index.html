<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é€±æœ«æŠ—æ‡¶æ•£</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æŠ—æ‡¶æ•£">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* é‡å° iOS å…¨è¢å¹•ç€æµ·è¨­è¨ˆå„ªåŒ– */
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body { 
            margin: 0; padding: 0; 
            font-family: -apple-system, "SF Pro TC", "Microsoft JhengHei", sans-serif; 
            background: #f0f2f5; overflow: hidden; 
        }
        
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* é ‚éƒ¨å°è¦½åˆ—å„ªåŒ– */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding-top: calc(var(--safe-top) + 15px);
            padding-bottom: 15px;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0) 100%);
            z-index: 1000; pointer-events: none; text-align: center;
        }
        .app-title { font-size: 1.1rem; font-weight: 900; color: #333; letter-spacing: 1px; }

        /* é¢æ¿è¨­è¨ˆ */
        .bottom-panel-container {
            position: absolute; bottom: 0; left: 0; width: 100%;
            z-index: 2000; pointer-events: none;
            display: flex; justify-content: center;
        }
        
        .bottom-panel {
            pointer-events: auto;
            width: 100%; max-width: 450px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
            padding: 0 20px calc(var(--safe-bottom) + 20px) 20px; 
            box-sizing: border-box;
            backdrop-filter: blur(15px);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .bottom-panel.minimized { transform: translateY(calc(100% - 85px)); }

        .panel-handle-area { width: 100%; height: 35px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .panel-handle { width: 40px; height: 5px; background: #ddd; border-radius: 10px; }

        /* æ¨¡å¼åˆ‡æ›å™¨ */
        .mode-switch-container {
            background: #f0f2f5; border-radius: 16px; padding: 4px;
            display: flex; margin-bottom: 20px; position: relative;
        }
        .mode-option { flex: 1; text-align: center; padding: 12px; font-size: 0.95rem; font-weight: bold; color: #888; cursor: pointer; z-index: 2; }
        .mode-option.active { color: #333; }
        .mode-slider {
            position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: calc(100% - 8px);
            background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1;
        }

        /* æŒ‰éˆ•è¨­è¨ˆ */
        .main-btn {
            width: 100%; padding: 18px; border: none; border-radius: 18px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; font-size: 1.1rem; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 8px 20px rgba(56, 239, 125, 0.3);
        }
        .main-btn.event-mode {
            background: linear-gradient(135deg, #8e44ad 0%, #ff7675 100%);
            box-shadow: 0 8px 20px rgba(142, 68, 173, 0.3);
        }

        #result-area { display: none; margin-top: 10px; }
        .res-tag { background: #e0f2f1; color: #009688; padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; }
        .res-tag.event { background: #f3e5f5; color: #8e44ad; }
        .res-title { font-size: 1.3rem; font-weight: 800; color: #2c3e50; margin: 10px 0; }
        .res-desc { font-size: 0.95rem; color: #555; line-height: 1.6; background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; }

        .action-row { display: flex; gap: 10px; }
        .btn-search { flex: 1; background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 12px; font-weight: bold; text-align: center; text-decoration: none; color: #555; font-size: 0.9rem; }
        .btn-link { flex: 1; background: #11998e; color: white; padding: 12px; border-radius: 12px; font-weight: bold; text-align: center; text-decoration: none; font-size: 0.9rem; }
        .btn-link.event { background: #8e44ad; }
        .btn-retry { width: 48px; background: #f0f0f0; border: none; border-radius: 12px; cursor: pointer; }

        .locate-btn {
            position: absolute; bottom: 320px; right: 20px;
            width: 48px; height: 48px; background: white; border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            z-index: 1500; transition: bottom 0.4s;
        }
        .bottom-panel.minimized ~ .locate-btn { bottom: 110px; }

        /* Loading */
        .loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.85); z-index: 3000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #38ef7d; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="margin-top:15px; font-weight:bold; color:#555;">æ­£åœ¨æƒæå‘¨é‚Š...</p>
    </div>

    <div class="top-bar">
        <div class="app-title">ğŸ‡¹ğŸ‡¼ é€±æœ«æŠ—æ‡¶æ•£ V9.1</div>
    </div>

    <div id="map"></div>

    <div class="bottom-panel-container">
        <div id="panel" class="bottom-panel">
            <div class="panel-handle-area" onclick="togglePanel()">
                <div class="panel-handle"></div>
            </div>

            <div class="full-content">
                <div class="mode-switch-container">
                    <div class="mode-slider" id="slider"></div>
                    <div class="mode-option active" onclick="switchMode('normal', 0)">æ—¥å¸¸æ¢éšª</div>
                    <div class="mode-option" onclick="switchMode('event', 100)">æœŸé–“é™å®š</div>
                </div>

                <div id="start-area">
                    <button id="main-btn" class="main-btn" onclick="startMission()">
                        <i class="fas fa-dice"></i> æŠ½ä¸€å¼µå†’éšªå¡
                    </button>
                    <p id="hint-text" style="text-align:center; font-size:0.8rem; color:#999; margin-top:10px;">
                        * éš¨æ©Ÿæœå°‹ 1km ~ 20km å…§çš„ç‰¹è‰²åœ°é»
                    </p>
                </div>

                <div id="result-area">
                    <div class="res-header">
                        <div class="res-tag" id="res-tag">é¡åˆ¥</div>
                        <div style="font-size:0.8rem; color:#888;" id="res-dist">è·é›¢</div>
                    </div>
                    <div class="res-title" id="res-name">åœ°é»åç¨±</div>
                    <div class="res-desc" id="res-desc">ä»»å‹™å…§å®¹</div>
                    <div class="action-row" id="action-buttons"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="locate-btn" onclick="getCurrentLocation()">
        <i class="fas fa-crosshairs"></i>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, userMarker, targetMarker, routeLine;
        let currentLat, currentLng;
        let currentMode = 'normal';

        // ä¼ºæœå™¨åˆ—è¡¨
        const nominatimUrl = "https://nominatim.openstreetmap.org/search";

        // æ¢éšªé¡åˆ¥
        const activityThemes = [
            { id: "uni", name: "ğŸ“ å¤§å­¸æ¼«æ­¥", keyword: "university", tasks: ["å»æ ¡åœ’æ•£æ­¥ï¼Œæ‰¾æ‰¾ä¾¿å®œå­¸é¤ã€‚", "åœ¨è‰çš®ç™¼å‘†çœ‹å­¸ç”Ÿã€‚"] },
            { id: "lib", name: "ğŸ“š éˆé­‚å……é›»", keyword: "library", tasks: ["éš¨æ©Ÿç¿»æœ¬é›œèªŒè®€20åˆ†é˜ã€‚", "æ‰¾æœ¬çµ•ç‰ˆæ›¸å°‹å¯¶ã€‚"] },
            { id: "temple", name: "â›©ï¸ çœ¾ç¥ä¿ä½‘", keyword: "temple", tasks: ["è§€å¯Ÿå»Ÿå®‡ç²¾ç¾çš„é›•åˆ»ã€‚", "é—œæ‰æ‰‹æ©Ÿæ²‰éœ5åˆ†é˜ã€‚"] },
            { id: "park", name: "ğŸŒ² è‡ªç„¶å‘¼å¸", keyword: "park", tasks: ["æ·±å‘¼å¸ä¸‰æ¬¡ï¼Œæ‰¾å›å¹³éœã€‚", "æ‹ä¸€å¼µæœ€ç¾çš„é¢¨æ™¯ç…§ã€‚"] },
            { id: "cafe", name: "â˜• ç¨ç«‹å’–å•¡", keyword: "cafe", tasks: ["é»ä¸€æ¯ç‰¹èª¿ï¼Œä¸æ»‘æ‰‹æ©Ÿã€‚", "è§€å¯Ÿåº—å“¡è·äººçš„å§¿æ…‹ã€‚"] },
            { id: "market", name: "ğŸ¥¬ å‚³çµ±å¸‚å ´", keyword: "market", tasks: ["é«”é©—åœ¨åœ°çš„å«è³£æ´»åŠ›ã€‚", "è²·ä¸€æ¨£æ²’åƒéçš„æ°´æœã€‚"] },
            { id: "historic", name: "ğŸ—ï¸ å¤è¹Ÿå·¡ç¦®", keyword: "historic", tasks: ["æ‘¸æ‘¸è€ç‰†å£ï¼Œæ„Ÿå—æ­·å²ã€‚", "æ‹å¼µå¾©å¤é¢¨æ ¼çš„ç…§ç‰‡ã€‚"] }
        ];

        const chainBlockList = ["Starbucks", "Louisa", "7-Eleven", "FamilyMart", "McDonald", "KFC", "PxMart", "Carrefour", "PX Mart"];

        window.onload = function() {
            initMap();
            getCurrentLocation();
        };

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([25.04, 121.51], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        function getCurrentLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        currentLat = pos.coords.latitude;
                        currentLng = pos.coords.longitude;
                        updateUserLocation();
                    },
                    () => { alert("è«‹é–‹å•Ÿå®šä½æ¬Šé™"); }
                );
            }
        }

        function updateUserLocation() {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([currentLat, currentLng], {
                radius: 8, fillColor: '#11998e', color: '#fff', weight: 3, fillOpacity: 1
            }).addTo(map);
            map.setView([currentLat, currentLng], 14);
        }

        function togglePanel() { document.getElementById('panel').classList.toggle('minimized'); }
        
        window.switchMode = function(mode, offset) {
            currentMode = mode;
            document.getElementById('slider').style.transform = `translateX(${offset}%)`;
            document.querySelectorAll('.mode-option').forEach((el, idx) => el.classList.toggle('active', (idx === (offset/100))));
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('start-area').style.display = 'block';
        }

        async function startMission() {
            document.getElementById('panel').classList.remove('minimized');
            showLoading("æ­£åœ¨æœå°‹åœ°åœ–...");
            const radius = Math.floor(Math.random() * 19000 + 1000);
            const theme = (currentMode === 'normal') 
                ? activityThemes[Math.floor(Math.random() * activityThemes.length)]
                : { name: "ğŸ›ï¸ è—æ–‡å ´é¤¨", keyword: "museum", task: "å»çœ‹çœ‹æµ·å ±ç‰†ï¼Œçœ‹æœ€è¿‘æœ‰ä»€éº¼å±•è¦½ã€‚" };
            
            fetchPlace(theme, radius);
        }

        async function fetchPlace(theme, radius) {
            const deg = radius / 111000;
            const viewbox = [currentLng-deg, currentLat+deg, currentLng+deg, currentLat-deg].join(',');
            const url = `${nominatimUrl}?q=${encodeURIComponent(theme.keyword)}&format=json&viewbox=${viewbox}&bounded=1&limit=25&addressdetails=1`;
            
            try {
                const res = await fetch(url);
                let data = await res.json();
                
                if (currentMode === 'normal') {
                    data = data.filter(p => !chainBlockList.some(c => (p.display_name||"").includes(c)));
                }

                if (data.length === 0) {
                    // ä¿åº•
                    if (theme.id !== 'park') return fetchPlace(activityThemes.find(t=>t.id==='park'), 5000);
                    else throw new Error();
                }

                const place = data[Math.floor(Math.random() * data.length)];
                const city = place.address.city || place.address.town || place.address.district || "";
                renderResult(place, theme, city);
            } catch (e) {
                alert("æœå°‹å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡");
                hideLoading();
            }
        }

        function renderResult(place, theme, city) {
            const lat = parseFloat(place.lat), lon = parseFloat(place.lon);
            const name = place.display_name.split(',')[0];
            const dist = (map.distance([currentLat, currentLng], [lat, lon]) / 1000).toFixed(1);

            if (targetMarker) map.removeLayer(targetMarker);
            if (routeLine) map.removeLayer(routeLine);

            const iconUrl = `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${currentMode === 'normal'?'green':'violet'}.png`;
            targetMarker = L.marker([lat, lon], {icon: L.icon({iconUrl, iconSize:[25,41], iconAnchor:[12,41]})}).addTo(map);
            routeLine = L.polyline([[currentLat, currentLng], [lat, lon]], {color: currentMode==='normal'?'#11998e':'#8e44ad', dashArray:'10,10'}).addTo(map);
            map.fitBounds(routeLine.getBounds().pad(0.3));

            document.getElementById('res-tag').innerText = theme.name;
            document.getElementById('res-tag').className = `res-tag ${currentMode==='event'?'event':''}`;
            document.getElementById('res-name').innerText = name;
            document.getElementById('res-dist').innerText = `${dist} km`;
            document.getElementById('res-desc').innerText = theme.task || theme.tasks[Math.floor(Math.random()*theme.tasks.length)];
            
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(name + ' ' + city + (currentMode==='normal'?' è©•åƒ¹':' å±•è¦½æ´»å‹•'))}`;
            const gmapUrl = `http://maps.google.com/maps?daddr=${lat},${lon}&dirflg=d`;

            document.getElementById('action-buttons').innerHTML = `
                <button class="btn-retry" onclick="startMission()"><i class="fas fa-redo"></i></button>
                <a href="${searchUrl}" target="_blank" class="btn-search"><i class="fab fa-google"></i> Google æœå°‹</a>
                <a href="${gmapUrl}" target="_blank" class="btn-link ${currentMode==='event'?'event':''}">å°èˆª</a>
            `;

            document.getElementById('start-area').style.display = 'none';
            document.getElementById('result-area').style.display = 'block';
            hideLoading();
        }

        function showLoading(t) { document.getElementById('loading-text').innerText = t; document.getElementById('loading').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }
    </script>
</body>
</html>
