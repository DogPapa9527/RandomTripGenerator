<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€±æœ«æŠ—æ‡¶æ•£ V3.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; font-family: "SF Pro TC", "Microsoft JhengHei", sans-serif; background: #f0f2f5; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* é ‚éƒ¨æ¨™é¡Œ */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 20px;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0) 100%);
            z-index: 1000; pointer-events: none;
            text-align: center;
        }
        .app-title { font-size: 1.1rem; font-weight: 900; color: #333; text-shadow: 0 2px 4px rgba(255,255,255,0.8); letter-spacing: 1px; }

        /* --- åº•éƒ¨é¢æ¿ --- */
        .bottom-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2000; padding: 20px; box-sizing: border-box;
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* æ¨¡å¼åˆ‡æ› Switch */
        .mode-switch-container {
            background: #f0f2f5; border-radius: 16px; padding: 5px;
            display: flex; margin-bottom: 20px; position: relative;
        }
        .mode-option {
            flex: 1; text-align: center; padding: 12px;
            font-size: 0.95rem; font-weight: bold; color: #888;
            cursor: pointer; z-index: 2; transition: color 0.3s;
        }
        .mode-option.active { color: #333; }
        
        /* æ»‘å‹•å¡Šå‹•ç•« */
        .mode-slider {
            position: absolute; top: 5px; left: 5px; width: calc(50% - 5px); height: calc(100% - 10px);
            background: white; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 1;
        }

        /* ä¸»æŒ‰éˆ• */
        .main-btn {
            width: 100%; padding: 18px; border: none; border-radius: 18px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white; font-size: 1.1rem; font-weight: 800;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s;
        }
        .main-btn:active { transform: scale(0.98); }
        /* æœŸé–“é™å®šæ¨¡å¼çš„æŒ‰éˆ•é¡è‰² */
        .main-btn.event-mode {
            background: linear-gradient(135deg, #8e44ad 0%, #ff7675 100%);
            box-shadow: 0 8px 20px rgba(142, 68, 173, 0.3);
        }

        /* çµæœé¡¯ç¤ºå€ (é è¨­éš±è—) */
        #result-area { display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        
        .res-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .res-tag { 
            background: #eef4ff; color: #3498db; padding: 5px 10px; 
            border-radius: 8px; font-size: 0.8rem; font-weight: bold; 
        }
        .res-tag.event { background: #f3e5f5; color: #8e44ad; }
        
        .res-title { font-size: 1.3rem; font-weight: 800; color: #2c3e50; margin-bottom: 8px; line-height: 1.3; }
        .res-desc { 
            font-size: 0.95rem; color: #555; line-height: 1.6; margin-bottom: 20px; 
            background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #3498db;
        }
        .res-desc.event { border-left-color: #8e44ad; }

        .action-row { display: flex; gap: 10px; }
        .btn-link {
            flex: 1; background: #3498db; color: white; text-decoration: none;
            padding: 12px; border-radius: 12px; font-weight: bold; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            font-size: 0.95rem;
        }
        .btn-link.event { background: #8e44ad; }
        .btn-retry {
            width: 45px; background: #f0f0f0; color: #555; border: none;
            border-radius: 12px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* å®šä½æŒ‰éˆ• */
        .locate-btn {
            position: absolute; bottom: 20px; right: 20px;
            width: 45px; height: 45px; background: white; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1500; color: #333;
        }
        /* ç•¶é¢æ¿æ‰“é–‹æ™‚ï¼Œå®šä½æŒ‰éˆ•å¾€ä¸Šç§» */
        .bottom-panel.expanded ~ .locate-btn { bottom: 320px; transition: bottom 0.3s; }

        /* Loading */
        .loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.8); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="margin-top:15px; font-weight:bold; color:#555;">æ­£åœ¨å®šä½ä¸­...</p>
    </div>

    <div class="top-bar">
        <div class="app-title">ğŸ‡¹ğŸ‡¼ é€±æœ«æŠ—æ‡¶æ•£ V3.0</div>
    </div>

    <div id="map"></div>

    <div class="locate-btn" onclick="getCurrentLocation()">
        <i class="fas fa-crosshairs"></i>
    </div>

    <div id="panel" class="bottom-panel">
        
        <div class="mode-switch-container">
            <div class="mode-slider" id="slider"></div>
            <div class="mode-option active" onclick="switchMode('normal', 0)">
                <i class="fas fa-home"></i> æ—¥å¸¸æ¢éšª
            </div>
            <div class="mode-option" onclick="switchMode('event', 100)">
                <i class="fas fa-ticket-alt"></i> æœŸé–“é™å®š
            </div>
        </div>

        <div id="start-area">
            <button id="main-btn" class="main-btn" onclick="startMission()">
                <i class="fas fa-dice"></i> å°‹æ‰¾ç¨ç«‹å¥½åº—
            </button>
            <p style="text-align:center; font-size:0.8rem; color:#999; margin-top:10px;">
                * ç³»çµ±å°‡è‡ªå‹•éæ¿¾ 90% çš„é€£é–åº—ï¼Œå¸¶ä½ ç™¼ç¾æ–°åœ°é»
            </p>
        </div>

        <div id="result-area">
            <div class="res-header">
                <div class="res-tag" id="res-tag">â˜• ç¨ç«‹å’–å•¡</div>
                <div style="font-size:0.8rem; color:#888;" id="res-dist">2.3 km</div>
            </div>
            
            <div class="res-title" id="res-name">è®€å–ä¸­...</div>
            <div class="res-desc" id="res-desc">è®€å–ä¸­...</div>

            <div class="action-row">
                <button class="btn-retry" onclick="startMission()">
                    <i class="fas fa-redo"></i>
                </button>
                <a id="res-link" href="#" target="_blank" class="btn-link">
                    <i class="fas fa-location-arrow"></i> å°èˆªå‡ºç™¼
                </a>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, userMarker, targetMarker, routeLine, rangeCircle;
        let currentLat, currentLng;
        let currentMode = 'normal'; // 'normal' or 'event'
        
        // é»‘åå–® (å¸¸è¦‹é€£é–åº—) - ç”¨æ–¼éæ¿¾
        const chainBlockList = [
            "7-Eleven", "7-ELEVEN", "FamilyMart", "å…¨å®¶", "Hi-Life", "èŠçˆ¾å¯Œ", "OK Mart", "OKè¶…å•†",
            "Starbucks", "æ˜Ÿå·´å…‹", "Louisa", "è·¯æ˜“è", "Cama", "85åº¦C", "85Â°C",
            "McDonald", "éº¥ç•¶å‹", "KFC", "è‚¯å¾·åŸº", "MOS Burger", "æ‘©æ–¯", "Subway",
            "PxMart", "å…¨è¯", "Carrefour", "å®¶æ¨‚ç¦", "Watsons", "å±ˆè‡£æ°", "Cosmed", "åº·æ˜¯ç¾",
            "Yoshinoya", "å‰é‡å®¶", "Sukiya", "ã™ãå®¶", "Laya", "æ‹‰äº"
        ];

        window.onload = function() {
            initMap();
            getCurrentLocation();
        };

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([25.0478, 121.5170], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ''
            }).addTo(map);
        }

        function getCurrentLocation() {
            showLoading("å®šä½ä¸­...");
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        currentLat = pos.coords.latitude;
                        currentLng = pos.coords.longitude;
                        updateUserLocation(currentLat, currentLng);
                        hideLoading();
                    },
                    (err) => {
                        alert("å®šä½å¤±æ•—ï¼Œé è¨­å°åŒ—è»Šç«™");
                        currentLat = 25.0478; currentLng = 121.5170;
                        updateUserLocation(currentLat, currentLng);
                        hideLoading();
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                hideLoading();
                alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
            }
        }

        function updateUserLocation(lat, lng) {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], {
                radius: 8, fillColor: '#2c3e50', color: '#fff', weight: 3, fillOpacity: 1
            }).addTo(map);
            map.setView([lat, lng], 14);
        }

        // --- æ¨¡å¼åˆ‡æ› ---
        window.switchMode = function(mode, offsetPercent) {
            currentMode = mode;
            document.getElementById('slider').style.transform = `translateX(${offsetPercent}%)`;
            
            const opts = document.querySelectorAll('.mode-option');
            opts.forEach(o => o.classList.remove('active'));
            if(mode === 'normal') opts[0].classList.add('active');
            else opts[1].classList.add('active');

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            const btn = document.getElementById('main-btn');
            const result = document.getElementById('result-area');
            
            // å¦‚æœå·²ç¶“æœ‰çµæœï¼Œå…ˆæ”¶èµ·ä¾†ï¼Œè®“ä½¿ç”¨è€…é‡æ–°æŒ‰
            result.style.display = 'none';
            document.getElementById('start-area').style.display = 'block';

            if (mode === 'normal') {
                btn.innerHTML = '<i class="fas fa-dice"></i> å°‹æ‰¾ç¨ç«‹å¥½åº—';
                btn.className = 'main-btn';
            } else {
                btn.innerHTML = '<i class="fas fa-ticket-alt"></i> å°‹æ‰¾ç•¶æœŸæ´»å‹•';
                btn.className = 'main-btn event-mode';
            }
        }

        // --- æ ¸å¿ƒä»»å‹™é‚è¼¯ ---
        async function startMission() {
            if (!currentLat) { alert("è«‹å…ˆå®šä½"); return; }
            
            // éš¨æ©ŸåŠå¾‘ï¼š1500m ~ 8000m (å¼·è¿«ç§»å‹•)
            const radius = Math.floor(Math.random() * (8000 - 1500) + 1500);
            
            showLoading(currentMode === 'normal' ? "æ­£åœ¨éæ¿¾é€£é–åº—..." : "æœå°‹å±•è¦½èˆ‡æ´»å‹•...");

            let query = "";
            
            if (currentMode === 'normal') {
                // æ—¥å¸¸æ¢éšªï¼šæ‰¾å’–å•¡å»³ã€é¤å»³ã€é…’å§ã€ç‰¹è‰²å•†åº—
                // æ’é™¤ä¾¿åˆ©å•†åº— (shop=convenience)
                query = `
                    [out:json][timeout:15];
                    (
                      node["amenity"~"cafe|restaurant|bar|pub"](around:${radius},${currentLat},${currentLng});
                      node["shop"~"books|bakery|tea"](around:${radius},${currentLat},${currentLng});
                    );
                    out 30;
                `;
            } else {
                // æœŸé–“é™å®šï¼šæ‰¾åšç‰©é¤¨ã€åŠ‡é™¢ã€é›»å½±é™¢ã€è—è¡“ä¸­å¿ƒ
                query = `
                    [out:json][timeout:15];
                    (
                      node["amenity"~"cinema|theatre|arts_centre"](around:${radius},${currentLat},${currentLng});
                      node["tourism"~"museum|gallery"](around:${radius},${currentLat},${currentLng});
                    );
                    out 20;
                `;
            }

            const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.elements || data.elements.length === 0) {
                    alert("é€™é™„è¿‘æœ‰é»è’æ¶¼ï¼Œæ‰¾ä¸åˆ°é©åˆçš„é»ã€‚è©¦è©¦çœ‹ç§»å‹•ä¸€ä¸‹ä½ç½®ï¼Ÿ");
                    hideLoading();
                    return;
                }

                // --- ç¯©é¸é‚è¼¯ ---
                let candidates = data.elements;
                
                if (currentMode === 'normal') {
                    // éæ¿¾é€£é–åº— (ä¿ç•™ 5% æ©Ÿç‡ä¸çœ‹é»‘åå–®ï¼Œç•¶ä½œå®‰æ…°ç)
                    const strictMode = Math.random() > 0.05; 
                    
                    if (strictMode) {
                        candidates = candidates.filter(place => {
                            const name = place.tags.name || "";
                            // æª¢æŸ¥æ˜¯å¦åœ¨é»‘åå–®ä¸­
                            return !chainBlockList.some(chain => name.includes(chain));
                        });
                    }
                }

                if (candidates.length === 0) {
                    // å¦‚æœéæ¿¾å®Œæ²’æ±è¥¿äº†ï¼Œå°±éš¨ä¾¿æŠ“ä¸€å€‹åŸæœ¬çš„
                    candidates = data.elements;
                }

                const place = candidates[Math.floor(Math.random() * candidates.length)];
                generateResult(place);

            } catch (e) {
                console.error(e);
                alert("æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                hideLoading();
            }
        }

        function generateResult(place) {
            const tags = place.tags || {};
            const name = tags.name || "æœªçŸ¥çš„ç§˜å¢ƒ";
            const lat = place.lat;
            const lon = place.lon;
            const dist = (map.distance([currentLat, currentLng], [lat, lon]) / 1000).toFixed(1);

            let type = "ğŸš© æ¢éšª";
            let desc = "";
            let linkText = "Google å°èˆª";
            let gmapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${lat},${lon}`; // é è¨­å°èˆª
            
            // --- æ–‡æ¡ˆç”Ÿæˆé‚è¼¯ ---
            if (currentMode === 'normal') {
                // æ—¥å¸¸æ¨¡å¼
                if (tags.amenity === 'cafe') {
                    type = "â˜• ç¨ç«‹å’–å•¡";
                    desc = `å‰å¾€ã€Œ${name}ã€ï¼Œé»ä¸€æ¯åº—è£¡çš„ç‰¹èª¿ï¼Œä¸¦è§€å¯Ÿåº—å“¡çš„é¸æ­Œå“å‘³ã€‚`;
                } else if (tags.amenity === 'bar' || tags.amenity === 'pub') {
                    type = "ğŸº å¾®é†ºæ™‚å…‰";
                    desc = `å‰å¾€ã€Œ${name}ã€ï¼Œé»ä¸€æ¯æ²’å–éçš„é…’ï¼Œæ…¶ç¥ä»Šå¤©é‚„æ´»è‘—ã€‚`;
                } else if (tags.shop === 'books') {
                    type = "ğŸ“š ç¨ç«‹æ›¸åº—";
                    desc = `å»ã€Œ${name}ã€é€›é€›ï¼Œè²·ä¸€æœ¬å°é¢å¸å¼•ä½ çš„æ›¸ï¼Œä¸è¦çœ‹æ›¸è©•ã€‚`;
                } else if (tags.amenity === 'restaurant') {
                    type = "ğŸ½ï¸ ç¾é£ŸæŒ–æ˜";
                    desc = `ä»Šå¤©å»åƒã€Œ${name}ã€ï¼Œè©¦è©¦çœ‹ç¶²è·¯ä¸Šè©•åƒ¹å…©æ¥µçš„é‚£é“èœã€‚`;
                } else {
                    type = "ğŸš¶ åŸå¸‚æ•£ç­–";
                    desc = `ç›®æ¨™æ˜¯ã€Œ${name}ã€ï¼Œä¸ä¸€å®šè¦é€²å»ï¼Œä½†åœ¨é–€å£æ‹å¼µç…§è­‰æ˜ä½ ä¾†éã€‚`;
                }
            } else {
                // æœŸé–“é™å®šæ¨¡å¼
                // é€™è£¡çš„ç­–ç•¥æ˜¯ï¼šå¼•å°ä½¿ç”¨è€…å»é‚£å€‹"å ´åœ°"ï¼Œä¸¦è‡ªå·±æŸ¥ç¾åœ¨æœ‰ä»€éº¼
                if (tags.amenity === 'cinema') {
                    type = "ğŸ¬ é›»å½±æ™‚å…‰";
                    desc = `å»ã€Œ${name}ã€çœ‹ä¸€å ´é›»å½±ã€‚ä¸æŒ‘ç‰‡ï¼Œç›´æ¥çœ‹æœ€è¿‘é–‹æ¼”çš„é‚£ä¸€å ´ï¼`;
                    linkText = "æŸ¥çœ‹å ´æ¬¡";
                } else if (tags.tourism === 'museum' || tags.tourism === 'gallery' || tags.amenity === 'arts_centre') {
                    type = "ğŸ¨ è—æ–‡å±•è¦½";
                    desc = `å‰å¾€ã€Œ${name}ã€ï¼Œçœ‹çœ‹ç¾åœ¨æœ‰ä»€éº¼å±•è¦½ã€‚å¦‚æœæ˜¯å”®ç¥¨å±•ï¼Œå°±è²·ç¥¨é€²å»ï¼`;
                    linkText = "æŸ¥çœ‹ç›®å‰å±•è¦½";
                } else {
                    type = "ğŸ­ å±•æ¼”æ´»å‹•";
                    desc = `å»ã€Œ${name}ã€èµ°èµ°ï¼Œçœ‹çœ‹ä»Šå¤©æœ‰æ²’æœ‰ä»€éº¼å¸‚é›†æˆ–è¡¨æ¼”æ´»å‹•ã€‚`;
                }
            }

            // --- æ›´æ–° UI ---
            // æ¨™è¨˜åœ°åœ–
            if (targetMarker) map.removeLayer(targetMarker);
            if (routeLine) map.removeLayer(routeLine);
            if (rangeCircle) map.removeLayer(rangeCircle);

            const iconUrl = currentMode === 'normal' 
                ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png'
                : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png';

            const icon = L.icon({
                iconUrl: iconUrl,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            targetMarker = L.marker([lat, lon], {icon: icon}).addTo(map);

            // ç•«ç·š
            const lineColor = currentMode === 'normal' ? '#3498db' : '#8e44ad';
            routeLine = L.polyline([[currentLat, currentLng], [lat, lon]], {
                color: lineColor, weight: 4, dashArray: '10, 10', opacity: 0.8
            }).addTo(map);
            map.fitBounds(routeLine.getBounds().pad(0.3));

            // æ›´æ–°é¢æ¿
            document.getElementById('res-tag').innerText = type;
            document.getElementById('res-tag').className = currentMode === 'normal' ? 'res-tag' : 'res-tag event';
            document.getElementById('res-dist').innerText = `è·é›¢ ${dist} km`;
            document.getElementById('res-name').innerText = name;
            document.getElementById('res-desc').innerText = desc;
            document.getElementById('res-desc').className = currentMode === 'normal' ? 'res-desc' : 'res-desc event';
            
            const btnLink = document.getElementById('res-link');
            btnLink.innerHTML = `<i class="fas fa-location-arrow"></i> ${linkText}`;
            btnLink.href = gmapUrl;
            btnLink.className = currentMode === 'normal' ? 'btn-link' : 'btn-link event';

            // å±•é–‹é¢æ¿
            document.getElementById('start-area').style.display = 'none';
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('panel').classList.add('expanded'); // æ¨™è¨˜å±•é–‹ç‹€æ…‹ä»¥ç§»å‹•å®šä½éˆ•

            hideLoading();
        }

        function showLoading(text) {
            document.getElementById('loading-text').innerText = text;
            document.getElementById('loading').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
