<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£é€±æœ«æŠ—æ‡¶æ•£ V2.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; font-family: "SF Pro TC", "Microsoft JhengHei", sans-serif; background: #f0f2f5; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* é ‚éƒ¨æ¨™é¡Œ */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 20px;
            background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 100%);
            z-index: 1000; pointer-events: none;
            display: flex; justify-content: space-between;
        }
        .app-title { font-size: 1.1rem; font-weight: 900; color: #333; text-shadow: 0 2px 4px rgba(255,255,255,0.8); }

        /* --- åº•éƒ¨é¢æ¿ (åŒ…å«æ§åˆ¶èˆ‡çµæœ) --- */
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
            z-index: 2000;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            max-height: 80vh;
            display: flex; flex-direction: column;
        }
        
        /* é¢æ¿æŠŠæ‰‹ (ç”¨ä¾†æŒ‡ç¤ºå¯æ»‘å‹•) */
        .sheet-handle-bar {
            width: 100%; padding: 10px 0; cursor: pointer;
            display: flex; justify-content: center;
        }
        .sheet-handle { width: 40px; height: 5px; background: #ddd; border-radius: 10px; }

        /* å…§å®¹å€åŸŸ */
        .sheet-content { padding: 0 20px 30px 20px; overflow-y: auto; }

        /* 1. è¨­å®šæ¨¡å¼ (é è¨­é¡¯ç¤º) */
        #setup-view { display: block; }
        
        /* äº¤é€šå·¥å…·æŒ‰éˆ• */
        .transport-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px;
        }
        .transport-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px 5px; border-radius: 12px;
            background: #f4f6f8; border: 2px solid transparent;
            cursor: pointer; transition: all 0.2s;
        }
        .transport-btn i { font-size: 1.2rem; margin-bottom: 5px; color: #888; }
        .transport-btn span { font-size: 0.7rem; font-weight: bold; color: #888; }
        .transport-btn.active { background: #e3f2fd; border-color: #4285f4; }
        .transport-btn.active i, .transport-btn.active span { color: #4285f4; }

        /* ä¸»æŒ‰éˆ• */
        .main-btn {
            width: 100%; padding: 16px; border: none; border-radius: 16px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white; font-size: 1.1rem; font-weight: 800;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .main-btn:active { transform: scale(0.98); }

        /* 2. çµæœæ¨¡å¼ (é è¨­éš±è—) */
        #result-view { display: none; }

        .mission-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .mission-badge {
            background: #eef4ff; color: #4285f4; padding: 4px 10px; 
            border-radius: 6px; font-size: 0.8rem; font-weight: bold;
        }
        .mission-dist { font-size: 0.85rem; color: #666; }

        .mission-title { font-size: 1.4rem; font-weight: 800; color: #333; margin-bottom: 8px; line-height: 1.3; }
        .mission-desc { 
            font-size: 1rem; color: #555; line-height: 1.6; margin-bottom: 20px; 
            background: #f9f9f9; padding: 15px; border-radius: 12px; border-left: 4px solid #ff6b6b;
        }

        .action-row { display: flex; gap: 10px; }
        .btn-gmap {
            flex: 2; background: #4285f4; color: white; text-decoration: none;
            padding: 12px; border-radius: 12px; font-weight: bold; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-retry {
            flex: 1; background: #f0f0f0; color: #555; border: none;
            padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer;
        }

        /* å®šä½æŒ‰éˆ• */
        .locate-btn {
            position: absolute; bottom: 200px; right: 20px; /* æ ¹æ“šé¢æ¿é«˜åº¦èª¿æ•´ */
            width: 45px; height: 45px; background: white; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 900; color: #333; transition: bottom 0.3s;
        }

        /* Loading */
        .loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.8); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #4285f4; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ç¸®å°ç‹€æ…‹ */
        .bottom-sheet.minimized { transform: translateY(calc(100% - 60px)); }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="margin-top:15px; font-weight:bold; color:#555;">æ­£åœ¨å®šä½ä¸­...</p>
    </div>

    <div class="top-bar">
        <div class="app-title">ğŸ‡¹ğŸ‡¼ é€±æœ«æŠ—æ‡¶æ•£ V2.0</div>
    </div>

    <div id="map"></div>

    <div class="locate-btn" id="locate-btn" onclick="getCurrentLocation()">
        <i class="fas fa-crosshairs"></i>
    </div>

    <div class="bottom-sheet" id="bottom-sheet">
        <div class="sheet-handle-bar" onclick="toggleSheet()">
            <div class="sheet-handle"></div>
        </div>
        
        <div class="sheet-content">
            
            <div id="setup-view">
                <div style="margin-bottom:10px; font-size:0.9rem; font-weight:bold; color:#555;">ä»Šå¤©æƒ³å»å¤šé ï¼Ÿ</div>
                <div class="transport-grid">
                    <div class="transport-btn" onclick="selectMode('walk', 800)">
                        <i class="fas fa-walking"></i>
                        <span>èµ°è·¯(800m)</span>
                    </div>
                    <div class="transport-btn" onclick="selectMode('bike', 2000)">
                        <i class="fas fa-bicycle"></i>
                        <span>å–®è»Š(2km)</span>
                    </div>
                    <div class="transport-btn active" onclick="selectMode('scooter', 5000)">
                        <i class="fas fa-motorcycle"></i>
                        <span>æ©Ÿè»Š(5km)</span>
                    </div>
                    <div class="transport-btn" onclick="selectMode('transit', 10000)">
                        <i class="fas fa-train"></i>
                        <span>æ·é‹(10km)</span>
                    </div>
                    <div class="transport-btn" onclick="selectMode('car', 30000)">
                        <i class="fas fa-car"></i>
                        <span>é–‹è»Š(30km)</span>
                    </div>
                </div>

                <button class="main-btn" onclick="findRealPlace()">
                    <i class="fas fa-search-location"></i> æœå°‹çœŸå¯¦åœ°é»ä¸¦æŒ‡æ´¾ä»»å‹™
                </button>
            </div>

            <div id="result-view">
                <div class="mission-header">
                    <div class="mission-badge" id="res-type">â˜• å’–å•¡å»³</div>
                    <div class="mission-dist" id="res-dist">è·é›¢ 1.2 km</div>
                </div>
                
                <div class="mission-title" id="res-name">è·¯æ˜“èå’–å•¡ Louisa Coffee</div>
                <div class="mission-desc" id="res-task">
                    ä»»å‹™ï¼šé»ä¸€æ¯ã€Œå°è¾²é›ªé»æ‹¿éµã€ï¼Œç„¶å¾Œæ‰¾å€‹è§’è½æŠŠæ‰‹æ©Ÿé—œéœéŸ³ 30 åˆ†é˜ã€‚
                </div>

                <div class="action-row">
                    <button class="btn-retry" onclick="resetView()">
                        <i class="fas fa-redo"></i> é‡æŠ½
                    </button>
                    <a id="res-gmap" href="#" target="_blank" class="btn-gmap">
                        <i class="fas fa-location-arrow"></i> Google å°èˆª
                    </a>
                </div>
            </div>

        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, userMarker, targetMarker, routeLine, rangeCircle;
        let currentLat, currentLng;
        let selectedRadius = 5000; // å…¬å°º
        let currentMode = 'scooter';

        // åˆå§‹åŒ–
        window.onload = function() {
            initMap();
            getCurrentLocation();
        };

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([25.0478, 121.5170], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ''
            }).addTo(map);
        }

        // --- 1. å®šä½åŠŸèƒ½ ---
        function getCurrentLocation() {
            showLoading("æ­£åœ¨å®šä½ä¸­...");
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        currentLat = pos.coords.latitude;
                        currentLng = pos.coords.longitude;
                        updateUserLocation(currentLat, currentLng);
                        hideLoading();
                    },
                    (err) => {
                        alert("å®šä½å¤±æ•—ï¼Œé è¨­ç‚ºå°åŒ—è»Šç«™");
                        currentLat = 25.0478; currentLng = 121.5170;
                        updateUserLocation(currentLat, currentLng);
                        hideLoading();
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                hideLoading();
                alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
            }
        }

        function updateUserLocation(lat, lng) {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], {
                radius: 8, fillColor: '#4285f4', color: '#fff', weight: 3, fillOpacity: 1
            }).addTo(map);
            map.setView([lat, lng], 15);
            updateRangeCircle();
        }

        // --- 2. åˆ‡æ›åŠå¾‘ ---
        window.selectMode = function(mode, radiusMeters) {
            document.querySelectorAll('.transport-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            selectedRadius = radiusMeters;
            currentMode = mode;
            updateRangeCircle();
        }

        function updateRangeCircle() {
            if (!currentLat) return;
            if (rangeCircle) map.removeLayer(rangeCircle);
            rangeCircle = L.circle([currentLat, currentLng], {
                radius: selectedRadius,
                color: '#4285f4', fillColor: '#4285f4', fillOpacity: 0.05, weight: 1, dashArray: '5, 5'
            }).addTo(map);
            map.fitBounds(rangeCircle.getBounds());
        }

        // --- 3. æ ¸å¿ƒï¼šæœå°‹çœŸå¯¦åœ°é» (Overpass API) ---
        async function findRealPlace() {
            if (!currentLat) { alert("è«‹å…ˆå®šä½"); return; }
            
            showLoading("æ­£åœ¨æœå°‹é™„è¿‘çš„çœŸå¯¦å¥½å»è™•...");
            
            // å»ºç«‹ Overpass Query
            // æˆ‘å€‘æœå°‹ï¼šå’–å•¡å»³ã€ä¾¿åˆ©å•†åº—ã€å…¬åœ’ã€åœ–æ›¸é¤¨ã€é€Ÿé£Ÿåº—
            const query = `
                [out:json][timeout:10];
                (
                  node["amenity"~"cafe|fast_food|library|restaurant"](around:${selectedRadius},${currentLat},${currentLng});
                  node["leisure"="park"](around:${selectedRadius},${currentLat},${currentLng});
                  node["shop"="convenience"](around:${selectedRadius},${currentLat},${currentLng});
                );
                out 20;
            `;
            // æ³¨æ„ï¼šout 20 è¡¨ç¤ºéš¨æ©Ÿå–å‰20å€‹ï¼Œé¿å…è³‡æ–™é‡éå¤§ã€‚

            const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!data.elements || data.elements.length === 0) {
                    alert("å“å‘€ï¼é€™é™„è¿‘æœ‰é»è’æ¶¼ï¼Œæ‰¾ä¸åˆ°é©åˆçš„é»ã€‚è©¦è©¦çœ‹æ“´å¤§ç¯„åœï¼Ÿ");
                    hideLoading();
                    return;
                }

                // éš¨æ©Ÿé¸ä¸€å€‹åœ°é»
                const place = data.elements[Math.floor(Math.random() * data.elements.length)];
                
                // ç”Ÿæˆä»»å‹™
                generateMissionFromPlace(place);
                
            } catch (error) {
                console.error(error);
                alert("é€£ç·šç™¼ç”Ÿå•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                hideLoading();
            }
        }

        // --- 4. ä»»å‹™ç”Ÿæˆé‚è¼¯ (Brand Logic) ---
        function generateMissionFromPlace(place) {
            const tags = place.tags || {};
            const name = tags.name || "æœªçŸ¥çš„åœ°é»";
            const lat = place.lat;
            const lon = place.lon;
            
            let type = "ğŸ“ ç¥ç§˜åœ°é»";
            let task = "å»é€™è£¡çœ‹çœ‹æœ‰ä»€éº¼æ–°ç™¼ç¾ï¼";

            // ç°¡å–®çš„é—œéµå­—åŒ¹é… (Brand Logic)
            if (tags.leisure === 'park' || name.includes("å…¬åœ’")) {
                type = "ğŸŒ³ å…¬åœ’æ”¾ç©º";
                task = "æ‰¾ä¸€å¼µé•·æ¤…åä¸‹ï¼Œç™¼å‘† 10 åˆ†é˜ï¼Œä¸å‡†æ»‘æ‰‹æ©Ÿï¼Œè§€å¯Ÿç¶“éçš„ 3 éš»ç‹—ã€‚";
            } else if (tags.amenity === 'library' || name.includes("åœ–æ›¸é¤¨")) {
                type = "ğŸ“š æ°£è³ªåŸ¹é¤Š";
                task = "é€²å»éš¨æ©ŸæŠ½ä¸€æœ¬æ›¸ï¼Œé–±è®€ç¬¬ 20 é çš„ç¬¬ä¸€å¥è©±ã€‚";
            } else if (tags.shop === 'convenience' || name.includes("7-Eleven") || name.includes("å…¨å®¶") || name.includes("èŠçˆ¾å¯Œ")) {
                type = "ğŸª è¶…å•†å†’éšª";
                if (name.includes("7-Eleven")) task = "é€²å»è²·ä¸€æ¯ City Cafeï¼Œæˆ–æ˜¯æ‰¾æ‰¾çœ‹æœ‰æ²’æœ‰æ–°çš„è¯åé›¶é£Ÿã€‚";
                else if (name.includes("å…¨å®¶")) task = "é€²å»è²·ä¸€æ”¯éœœæ·‡æ·‹ï¼Œä¸ç®¡ä»Šå¤©å¤©æ°£å¦‚ä½•ï¼";
                else task = "é€²å»è²·ä¸€ç“¶ä½ å¾æ²’å–éçš„é£²æ–™ã€‚";
            } else if (name.includes("è·¯æ˜“è") || name.includes("Louisa")) {
                type = "â˜• è·¯æ˜“èä»»å‹™";
                task = "é»ä¸€æ¯ã€ŒèŠåœ’ç´šæ‹¿éµã€æˆ–æ˜¯ã€Œè”æç´…èŒ¶ã€ï¼Œä¸¦ä½”é ˜ä¸€å€‹æ’åº§ä½ç½®ã€‚";
            } else if (name.includes("æ˜Ÿå·´å…‹") || name.includes("Starbucks")) {
                type = "â˜• æ˜Ÿå·´å…‹ä»»å‹™";
                task = "é»ä¸€æ¯ã€Œæœ¬æ—¥ç²¾é¸ã€æˆ–è«‹åº—å“¡æ¨è–¦ç‰¹èª¿ï¼Œååœ¨çª—é‚Šçœ‹äººã€‚";
            } else if (name.includes("éº¥ç•¶å‹")) {
                type = "ğŸ” éº¥ç•¶å‹ä»»å‹™";
                task = "é»ä¸€ä»½ä½ å¹³å¸¸ä¸æœƒé»çš„æ¼¢å ¡ï¼Œæˆ–è€…åªåƒè›‹æ²å†°æ·‡æ·‹ã€‚";
            } else if (tags.amenity === 'cafe') {
                type = "â˜• å°‹æ‰¾å’–å•¡";
                task = `å‰å¾€ã€Œ${name}ã€ï¼Œé»ä¸€æ¯æ‹›ç‰Œå’–å•¡ï¼Œä¸¦æ‹å¼µç…§ä¸Šå‚³é™å‹•ã€‚`;
            } else if (tags.amenity === 'restaurant' || tags.amenity === 'fast_food') {
                type = "ğŸ½ï¸ ç¾é£Ÿæ¢éšª";
                task = `å‰å¾€ã€Œ${name}ã€ï¼Œçœ‹çœ‹èœå–®ä¸Šçœ‹èµ·ä¾†æœ€å²å®³çš„é‚£é“èœæ˜¯ä»€éº¼ã€‚`;
            } else {
                // é è¨­
                type = "ğŸš© æ¢ç´¢æœªçŸ¥";
                task = `å‰å¾€ã€Œ${name}ã€ï¼Œçœ‹çœ‹é‚£è£¡é•·ä»€éº¼æ¨£å­ï¼Œæ‹å¼µç…§ç•™å¿µã€‚`;
            }

            // æ›´æ–° UI
            showResult(name, type, task, lat, lon);
        }

        function showResult(name, type, task, lat, lon) {
            // æ¨™è¨˜åœ°åœ–
            if (targetMarker) map.removeLayer(targetMarker);
            if (routeLine) map.removeLayer(routeLine);

            const redIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            targetMarker = L.marker([lat, lon], {icon: redIcon}).addTo(map);
            
            routeLine = L.polyline([[currentLat, currentLng], [lat, lon]], {
                color: '#4285f4', weight: 4, dashArray: '10, 10', opacity: 0.8
            }).addTo(map);
            
            map.fitBounds(routeLine.getBounds().pad(0.3));

            // è¨ˆç®—è·é›¢
            const dist = (map.distance([currentLat, currentLng], [lat, lon]) / 1000).toFixed(1);

            // æ›´æ–°æ–‡å­—
            document.getElementById('res-type').innerText = type;
            document.getElementById('res-dist').innerText = `è·é›¢ ${dist} km`;
            document.getElementById('res-name').innerText = name;
            document.getElementById('res-task').innerText = task;

            // Google Maps Link
            let travelMode = 'driving';
            if(currentMode === 'walk') travelMode = 'walking';
            if(currentMode === 'bike') travelMode = 'bicycling';
            if(currentMode === 'transit') travelMode = 'transit';
            
            // é€™è£¡ä½¿ç”¨ `api=1&query=` ç¢ºä¿ç²¾æº–æœå°‹è©²åº—åèˆ‡åº§æ¨™
            const gmapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${lat},${lon}`;
            // æˆ–æ˜¯å°èˆªæ¨¡å¼: `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=${travelMode}`;
            const dirUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=${travelMode}`;
            
            document.getElementById('res-gmap').href = dirUrl;

            // åˆ‡æ›è¦–åœ–
            document.getElementById('setup-view').style.display = 'none';
            document.getElementById('result-view').style.display = 'block';
            
            hideLoading();
        }

        function resetView() {
            document.getElementById('result-view').style.display = 'none';
            document.getElementById('setup-view').style.display = 'block';
            
            if(targetMarker) map.removeLayer(targetMarker);
            if(routeLine) map.removeLayer(routeLine);
            map.setView([currentLat, currentLng], 14);
        }

        // --- UI æ§åˆ¶ ---
        function toggleSheet() {
            document.getElementById('bottom-sheet').classList.toggle('minimized');
        }

        function showLoading(text) {
            document.getElementById('loading-text').innerText = text;
            document.getElementById('loading').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
