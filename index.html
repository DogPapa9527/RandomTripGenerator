<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€±æœ«æŠ—æ‡¶æ•£ V9.0 (æ——è‰¦ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; font-family: "SF Pro TC", "Microsoft JhengHei", sans-serif; background: #f0f2f5; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px 20px;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0) 100%);
            z-index: 1000; pointer-events: none; text-align: center;
        }
        .app-title { font-size: 1.1rem; font-weight: 900; color: #333; text-shadow: 0 2px 4px rgba(255,255,255,0.8); letter-spacing: 1px; }

        .bottom-panel-container {
            position: absolute; bottom: 0; left: 0; width: 100%;
            z-index: 2000; pointer-events: none;
            display: flex; justify-content: center;
        }
        
        .bottom-panel {
            pointer-events: auto;
            width: 95%; max-width: 420px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
            padding: 0 20px 30px 20px; box-sizing: border-box;
            backdrop-filter: blur(10px);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            transform: translateY(0);
        }
        .bottom-panel.minimized { transform: translateY(calc(100% - 75px)); }

        .panel-handle-area {
            width: 100%; height: 35px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .panel-handle { width: 50px; height: 5px; background: #e0e0e0; border-radius: 10px; }

        .mode-switch-container {
            background: #f0f2f5; border-radius: 16px; padding: 5px;
            display: flex; margin-bottom: 20px; position: relative;
        }
        .mode-option {
            flex: 1; text-align: center; padding: 12px; font-size: 0.95rem; font-weight: bold; color: #888;
            cursor: pointer; z-index: 2; transition: color 0.3s;
        }
        .mode-option.active { color: #333; }
        .mode-slider {
            position: absolute; top: 5px; left: 5px; width: calc(50% - 5px); height: calc(100% - 10px);
            background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); z-index: 1;
        }

        .main-btn {
            width: 100%; padding: 18px; border: none; border-radius: 18px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; font-size: 1.1rem; font-weight: 800;
            box-shadow: 0 8px 20px rgba(56, 239, 125, 0.3);
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s;
        }
        .main-btn:active { transform: scale(0.98); }
        .main-btn.event-mode {
            background: linear-gradient(135deg, #8e44ad 0%, #ff7675 100%);
            box-shadow: 0 8px 20px rgba(142, 68, 173, 0.3);
        }

        #result-area { display: none; margin-top: 10px; }
        .mini-header { display: none; align-items: center; justify-content: space-between; }
        .bottom-panel.minimized .mini-header { display: flex; }
        .bottom-panel.minimized .full-content { display: none; }

        .res-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .res-tag { background: #e0f2f1; color: #009688; padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; }
        .res-tag.event { background: #f3e5f5; color: #8e44ad; }
        .res-tag.fallback { background: #fff3e0; color: #e67e22; }
        
        .res-title { font-size: 1.3rem; font-weight: 800; color: #2c3e50; margin-bottom: 8px; line-height: 1.3; }
        .res-desc { 
            font-size: 0.95rem; color: #555; line-height: 1.6; margin-bottom: 15px; 
            background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #38ef7d;
        }
        .res-desc.event { border-left-color: #8e44ad; }
        .res-desc.fallback { border-left-color: #e67e22; }

        .action-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-search {
            flex: 1; background: #fff; border: 1px solid #ddd; color: #555; text-decoration: none;
            padding: 12px; border-radius: 12px; font-weight: bold; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-link {
            flex: 1; background: #11998e; color: white; text-decoration: none;
            padding: 12px; border-radius: 12px; font-weight: bold; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(17, 153, 142, 0.3);
        }
        .btn-link.event { background: #8e44ad; box-shadow: 0 4px 10px rgba(142, 68, 173, 0.3); }
        .btn-link.fallback { background: #e67e22; box-shadow: 0 4px 10px rgba(230, 126, 34, 0.3); }

        .btn-retry {
            width: 45px; background: #f0f0f0; color: #555; border: none;
            border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .locate-btn {
            position: absolute; bottom: 300px; right: 20px;
            width: 45px; height: 45px; background: white; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1500; color: #333; transition: bottom 0.3s;
        }
        .bottom-panel.minimized ~ .locate-btn { bottom: 100px; }

        .loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.8); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #38ef7d; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="margin-top:15px; font-weight:bold; color:#555;">æ­£åœ¨å®šä½ä¸­...</p>
    </div>

    <div class="top-bar">
        <div class="app-title">ğŸ‡¹ğŸ‡¼ é€±æœ«æŠ—æ‡¶æ•£ V9.0</div>
    </div>

    <div id="map"></div>

    <div class="bottom-panel-container">
        <div id="panel" class="bottom-panel">
            <div class="panel-handle-area" onclick="togglePanel()">
                <div class="panel-handle"></div>
            </div>

            <div class="mini-header">
                <div style="font-weight:800; color:#333; font-size:1.1rem;" id="mini-title">å°šæœªé–‹å§‹</div>
                <button class="btn-retry" style="height:35px;" onclick="event.stopPropagation(); startMission()">
                    <i class="fas fa-redo"></i>
                </button>
            </div>

            <div class="full-content">
                <div class="mode-switch-container">
                    <div class="mode-slider" id="slider"></div>
                    <div class="mode-option active" onclick="switchMode('normal', 0)">
                        <i class="fas fa-tree"></i> å¤šå…ƒæ¢éšª
                    </div>
                    <div class="mode-option" onclick="switchMode('event', 100)">
                        <i class="fas fa-calendar-alt"></i> æ´»å‹•/å±•è¦½
                    </div>
                </div>

                <div id="start-area">
                    <button id="main-btn" class="main-btn" onclick="startMission()">
                        <i class="fas fa-random"></i> éš¨æ©Ÿç”Ÿæˆè¡Œç¨‹
                    </button>
                    <p id="hint-text" style="text-align:center; font-size:0.8rem; color:#999; margin-top:10px;">
                        * æœå°‹ç¯„åœ 1km ~ 20kmï¼ŒåŒ…å« 16 ç¨®æ¢éšªä¸»é¡Œ
                    </p>
                </div>

                <div id="result-area">
                    <div class="res-header">
                        <div class="res-tag" id="res-tag">é¡åˆ¥</div>
                        <div style="font-size:0.8rem; color:#888;" id="res-dist">è·é›¢</div>
                    </div>
                    
                    <div class="res-title" id="res-name">åœ°é»åç¨±</div>
                    <div class="res-desc" id="res-desc">ä»»å‹™å…§å®¹</div>

                    <div class="action-row" id="action-buttons">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div class="locate-btn" onclick="getCurrentLocation()">
        <i class="fas fa-crosshairs"></i>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, userMarker, targetMarker, routeLine, rangeCircle;
        let currentLat, currentLng;
        let currentMode = 'normal';

        // --- V9.0 æ——è‰¦ç´šä»»å‹™é¡Œåº« ---
        // keyword: ç”¨æ–¼ Nominatim æœå°‹
        const activityThemes = [
            // åŸå¸‚äººæ–‡
            { id: "university", name: "ğŸ“ å¤§å­¸æ¼«æ­¥", keyword: "university", tasks: ["å»æ ¡åœ’è£¡æ•£æ­¥ï¼Œæ‰¾æ‰¾ä¾¿å®œå­¸é¤ã€‚", "åœ¨è‰çš®ä¸Šç™¼å‘†ï¼Œè§€å¯Ÿå­¸ç”Ÿã€‚", "å»å­¸æ ¡åˆä½œç¤¾è²·ç“¶é£²æ–™ã€‚", "æ‰¾åˆ°æ ¡åœ’è£¡æœ€è€çš„ä¸€æ£µæ¨¹ã€‚"] },
            { id: "library", name: "ğŸ“š éˆé­‚å……é›»", keyword: "library", tasks: ["é€²å»éš¨æ©ŸæŠ½ä¸€æœ¬é›œèªŒï¼Œè®€ 20 åˆ†é˜ã€‚", "èµ°åˆ°æ—…éŠæ›¸å€ï¼Œæ±ºå®šä¸‹æ¬¡æ—…è¡Œçš„åœ‹å®¶ã€‚", "æ‰¾ä¸€æœ¬ä½ å‡ºç”Ÿé‚£å¹´å‡ºç‰ˆçš„æ›¸ã€‚", "ä¸å¸¶æ‰‹æ©Ÿï¼Œç´”ç²¹äº«å—å®‰éœã€‚"] },
            { id: "temple", name: "â›©ï¸ çœ¾ç¥ä¿ä½‘", keyword: "temple", tasks: ["é€²å»æ„Ÿå—å»ºç¯‰çš„å¯§éœã€‚", "è§€å¯Ÿå»Ÿå®‡/æ•™å ‚è£¡çš„é›•åˆ»ç´°ç¯€ã€‚", "åœ¨é™„è¿‘æ‰¾å€‹åœ°æ–¹åè‘—ï¼Œè½è½é˜è²æˆ–èª¦ç¶“è²ã€‚", "åœ¨å¿ƒè£¡é»˜å”¸é€™é€±ç™¼ç”Ÿçš„ä¸€ä»¶å¥½äº‹ã€‚"] },
            { id: "market", name: "ğŸ® æ‡·èˆŠå¸‚å ´", keyword: "marketplace", tasks: ["èµ°é€²å»æ„Ÿå—åœ¨åœ°çš„æ´»åŠ›ã€‚", "è²·ä¸€æ¨£ç•¶å­£æ°´æœã€‚", "æ‰¾æ‰¾çœ‹æœ‰æ²’æœ‰æ²’åƒéçš„å‚³çµ±é»å¿ƒã€‚", "è½è½æ”¤è²©çš„å«è³£è²ã€‚"] },
            { id: "cafe", name: "â˜• ç¨ç«‹å’–å•¡", keyword: "cafe", tasks: ["é»ä¸€æ¯æ²’å–éçš„ç‰¹èª¿ã€‚", "ä¸æ»‘æ‰‹æ©Ÿï¼Œè§€å¯Ÿåº—å“¡æ²–å’–å•¡çš„å‹•ä½œã€‚", "å¸¶ä¸€æœ¬ç­†è¨˜æœ¬ï¼Œå¯«ä¸‹é€™é€±çš„å¿ƒæƒ…ã€‚", "ååœ¨çª—é‚Šè§€å¯Ÿè·¯äººã€‚"] },
            
            // èº«é«”èˆ‡æ„Ÿå®˜
            { id: "park", name: "ğŸŒ² è‡ªç„¶æ£®å‘¼å¸", keyword: "park", tasks: ["æ‰¾åˆ°é€™å€‹åœ°æ–¹çš„æœ€é«˜é»ï¼Œæ·±å‘¼å¸ä¸‰æ¬¡ã€‚", "æ‰¾å¼µé•·æ¤…ç™¼å‘† 10 åˆ†é˜ã€‚", "è„«ä¸‹é‹å­(å¦‚æœå¯ä»¥)ï¼Œèµ¤è…³è¸©è¸©è‰åœ°ã€‚", "æ‹ä¸€å¼µé€†å…‰çš„æ¨¹è‘‰ç…§ç‰‡ã€‚"] },
            { id: "hot_spring", name: "â™¨ï¸ åŸå¸‚ç§˜æ¹¯", keyword: "hot spring", tasks: ["å»æ³¡å€‹è…³ï¼Œæ”¾é¬†ä¸€ä¸‹ã€‚", "æ‰¾æ‰¾çœ‹æœ‰æ²’æœ‰ä¾¿å®œçš„å…¬å…±æµ´æ± ã€‚", "åœ¨æº«æ³‰å€è²·é¡†æº«æ³‰è›‹ã€‚"] },
            { id: "sports", name: "ğŸƒ å‹•èµ·ä¾†", keyword: "sports_centre", tasks: ["å»ç”°å¾‘å ´èµ°å…©åœˆã€‚", "è§€å¯Ÿåˆ¥äººéƒ½åœ¨åšä»€éº¼é‹å‹•ã€‚", "å»é‡å€‹é«”é‡é«”è„‚(å¦‚æœæœ‰æ©Ÿå™¨)ã€‚"] },
            
            // æŒ–å¯¶èˆ‡å†’éšª
            { id: "bakery", name: "ğŸ° å··å¼„ç”œé»", keyword: "bakery", tasks: ["è²·ä¸€å€‹çœ‹èµ·ä¾†æœ€å²å®³çš„éºµåŒ…ã€‚", "æ‰¾æ‰¾çœ‹æœ‰æ²’æœ‰å‰›å‡ºçˆçš„é»å¿ƒã€‚", "è²·ä¸€å¡Šè›‹ç³•çŠ’è³è‡ªå·±ã€‚"] },
            { id: "bookstore", name: "ğŸ“– æ›¸é¦™å°‹å¯¶", keyword: "bookstore", tasks: ["å»æ‰¾ä¸€æœ¬çµ•ç‰ˆæ›¸æˆ–äºŒæ‰‹æ›¸ã€‚", "è²·ä¸€æœ¬å°é¢å¸å¼•ä½ çš„æ›¸ã€‚", "ç¿»é–±ä¸€æœ¬æ”å½±é›†ã€‚"] },
            { id: "florist", name: "ğŸŒ¸ èŠ±é³¥å¸‚å ´", keyword: "florist", tasks: ["è²·ä¸€ç›†ä¸éœ€è¦å¤ªè²»å¿ƒç…§é¡§çš„å°æ¤ç‰©ã€‚", "é€²å»èèèŠ±çš„é¦™å‘³ã€‚", "èªè­˜ä¸‰ç¨®ä½ å«ä¸å‡ºåå­—çš„èŠ±ã€‚"] },
            
            // ç‰¹æ®Šèˆ‡å°çœ¾
            { id: "viewpoint", name: "ğŸ‘ è§€æ™¯é«˜åœ°", keyword: "viewpoint", tasks: ["å¾ä¸åŒè§’åº¦çœ‹ä½ ä½çš„åŸå¸‚ã€‚", "æ‹ä¸€å¼µå…¨æ™¯ç…§ç‰‡ã€‚", "å¤§å–Šä¸€è²(å¦‚æœæ²’äººçš„è©±)ã€‚"] },
            { id: "historic", name: "ğŸ—ï¸ è€å±‹å†ç”Ÿ", keyword: "historic", tasks: ["å»æ‘¸æ‘¸çœ‹è€å»ºç¯‰çš„ç‰†å£ã€‚", "æƒ³åƒä¸€ä¸‹ 50 å¹´å‰é€™è£¡çš„äººåœ¨åšä»€éº¼ã€‚", "æ‹ä¸€å¼µé»‘ç™½é¢¨æ ¼çš„ç…§ç‰‡ã€‚"] },
            { id: "station", name: "ğŸš‚ éµé“è¿·è¹¤", keyword: "railway station", tasks: ["å»ä¸€å€‹æ²’è½éçš„å°è»Šç«™æ™ƒæ™ƒã€‚", "è§€å¯Ÿç«è»Šé€²ç«™çš„ç¬é–“ã€‚", "è²·ä¸€å¼µæœ€ä¾¿å®œçš„ç¥¨ç•™ä½œç´€å¿µã€‚"] },
            { id: "restaurant", name: "ğŸ½ï¸ åœ¨åœ°ç¾é£Ÿ", keyword: "restaurant", tasks: ["é»ä¸€é“ä½ å¹³å¸¸ä¸æœƒåƒçš„èœã€‚", "çœ‹çœ‹åˆ¥æ¡Œéƒ½é»ä»€éº¼ã€‚", "æ‰¾ä¸€å®¶è©•åƒ¹å¾ˆé«˜ä½†æ²’åƒéçš„åº—ã€‚"] }
        ];

        // é€£é–åº—é»‘åå–®
        const chainBlockList = ["Starbucks", "Louisa", "7-Eleven", "FamilyMart", "McDonald", "KFC", "PxMart", "Carrefour", "PX Mart", "Mos Burger", "Subway", "85C", "Cama"];

        window.onload = function() {
            initMap();
            getCurrentLocation();
        };

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([25.0478, 121.5170], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: ''}).addTo(map);
        }

        function getCurrentLocation() {
            showLoading("å®šä½ä¸­...");
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        currentLat = pos.coords.latitude;
                        currentLng = pos.coords.longitude;
                        updateUserLocation(currentLat, currentLng);
                        hideLoading();
                    },
                    (err) => {
                        alert("å®šä½å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä½ç½®");
                        currentLat = 25.0478; currentLng = 121.5170; 
                        updateUserLocation(currentLat, currentLng);
                        hideLoading();
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                hideLoading();
                alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
            }
        }

        function updateUserLocation(lat, lng) {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], {
                radius: 8, fillColor: '#11998e', color: '#fff', weight: 3, fillOpacity: 1
            }).addTo(map);
            map.setView([lat, lng], 14);
        }

        function togglePanel() {
            document.getElementById('panel').classList.toggle('minimized');
        }

        function expandPanel() {
            document.getElementById('panel').classList.remove('minimized');
        }

        window.switchMode = function(mode, offsetPercent) {
            currentMode = mode;
            document.getElementById('slider').style.transform = `translateX(${offsetPercent}%)`;
            const opts = document.querySelectorAll('.mode-option');
            opts.forEach(o => o.classList.remove('active'));
            if(mode === 'normal') opts[0].classList.add('active');
            else opts[1].classList.add('active');

            const btn = document.getElementById('main-btn');
            const hint = document.getElementById('hint-text');
            
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('start-area').style.display = 'block';

            if (mode === 'normal') {
                btn.innerHTML = '<i class="fas fa-random"></i> éš¨æ©Ÿç”Ÿæˆè¡Œç¨‹';
                btn.className = 'main-btn';
                hint.innerText = "* ç¯„åœ 1~20kmï¼ŒåŒ…å« 16 ç¨®æ¢éšªé¡åˆ¥";
            } else {
                btn.innerHTML = '<i class="fas fa-search"></i> æœå°‹æ´»å‹•å ´é¤¨';
                btn.className = 'main-btn event-mode';
                hint.innerText = "* æœå°‹é™„è¿‘çš„è—è¡“ä¸­å¿ƒã€åšç‰©é¤¨ã€å±•æ¼”ç©ºé–“";
            }
        }

        async function startMission() {
            if (!currentLat) { alert("è«‹å…ˆå®šä½"); return; }
            expandPanel();
            
            // éš¨æ©ŸåŠå¾‘: 1km ~ 20km (ä¸æ”¾æ£„å®¶è£¡é™„è¿‘ï¼Œä¹Ÿä¸æ’æ–¥é æ–¹)
            const radius = Math.floor(Math.random() * (20000 - 1000) + 1000);
            
            if (currentMode === 'normal') {
                showLoading("æ­£åœ¨æƒæå‘¨é‚Š...");
                // éš¨æ©ŸæŠ½é¸ä¸»é¡Œ
                const theme = activityThemes[Math.floor(Math.random() * activityThemes.length)];
                fetchNominatim(theme, radius);
            } else {
                showLoading("æ­£åœ¨æœå°‹å±•è¦½å ´é¤¨...");
                // å±•è¦½æ¨¡å¼
                const theme = { 
                    name: "ğŸ›ï¸ è—æ–‡å ´é¤¨", 
                    keyword: "museum", // é è¨­å…ˆæ‰¾åšç‰©é¤¨
                    task: "å‰å¾€æ­¤è™•ï¼Œçœ‹çœ‹æµ·å ±ç‰†æˆ–å”®ç¥¨å£æœ€è¿‘æœ‰ä»€éº¼æ¼”å‡ºæˆ–å±•è¦½ã€‚"
                };
                // å±•è¦½æ¨¡å¼æœ‰æ™‚å€™åšç‰©é¤¨æ‰¾ä¸åˆ°ï¼Œå¯ä»¥å˜—è©¦ Arts Centre
                // é€™è£¡åšå€‹ç°¡å–®éš¨æ©Ÿ
                if (Math.random() > 0.5) theme.keyword = "arts_centre";
                
                fetchNominatim(theme, radius);
            }
        }

        // --- Nominatim API ---
        async function fetchNominatim(theme, radius) {
            // è¨ˆç®— Bounding Box
            const degLat = radius / 111000;
            const degLng = radius / (111000 * Math.cos(currentLat * Math.PI / 180));
            
            const viewbox = [
                currentLng - degLng, // left
                currentLat + degLat, // top
                currentLng + degLng, // right
                currentLat - degLat  // bottom
            ].join(',');

            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(theme.keyword)}&format=json&viewbox=${viewbox}&bounded=1&limit=20&addressdetails=1`;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error("API Error");
                const data = await response.json();

                let candidates = data;

                // éæ¿¾é€£é–åº—
                if (currentMode === 'normal') {
                    candidates = candidates.filter(place => {
                        const name = (place.name || "").toLowerCase();
                        return !chainBlockList.some(chain => name.includes(chain.toLowerCase()));
                    });
                }

                // æ‰¾ä¸åˆ°è³‡æ–™ -> ä¿åº•
                if (candidates.length === 0) {
                    console.warn(`é¡åˆ¥ ${theme.name} ç„¡çµæœï¼Œåˆ‡æ›ä¿åº•`);
                    if (theme.id !== 'park') {
                        // æ‰¾ä¸åˆ°å¤§å­¸/æº«æ³‰/å¤è¹Ÿ -> æ”¹æ‰¾å…¬åœ’ (ä¸€å®šæœ‰)
                        const fallbackTheme = activityThemes.find(t => t.id === 'park');
                        // éè¿´å‘¼å«ï¼Œä½†æŠŠåŠå¾‘è¨­ç‚º 5km (ç¢ºä¿æ‰¾å¾—åˆ°)
                        fetchNominatim(fallbackTheme, 5000); 
                        return;
                    } else {
                        triggerGoogleMapsFallback(theme);
                        return;
                    }
                }

                const place = candidates[Math.floor(Math.random() * candidates.length)];
                
                // æå–è¡Œæ”¿å€
                const addr = place.address || {};
                const city = addr.city || addr.town || addr.district || addr.county || "";
                
                let taskText = theme.task;
                if (theme.tasks) taskText = theme.tasks[Math.floor(Math.random() * theme.tasks.length)];

                generateResult(place, theme.name, taskText, city);

            } catch (e) {
                console.error(e);
                triggerGoogleMapsFallback(theme);
            }
        }

        // --- çµ‚æ¥µä¿åº• ---
        function triggerGoogleMapsFallback(theme) {
            hideLoading();
            const fallbackName = `é™„è¿‘çš„ ${theme.name.replace(/^[^\s]+\s/, '')}`; // ç§»é™¤ emoji
            
            // æœå°‹é€£çµ
            const gmapSearchUrl = `https://www.google.com/maps/search/${encodeURIComponent(fallbackName)}`;
            
            if (targetMarker) map.removeLayer(targetMarker);
            if (routeLine) map.removeLayer(routeLine);
            if (rangeCircle) map.removeLayer(rangeCircle);

            document.getElementById('res-tag').innerText = "ğŸ’¡ éˆæ„Ÿå»ºè­°";
            document.getElementById('res-tag').className = "res-tag fallback";
            document.getElementById('res-dist').innerText = "æœªçŸ¥è·é›¢";
            document.getElementById('res-name').innerText = fallbackName;
            
            document.getElementById('res-desc').innerHTML = "åœ°åœ–è³‡æ–™é€£ç·šå¿™ç¢Œï¼Œä½†åˆ¥å› æ­¤æ”¾æ£„å‡ºé–€ï¼<br>é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œç›´æ¥åœ¨ Google Maps å°‹æ‰¾ç›®æ¨™ã€‚";
            document.getElementById('res-desc').className = "res-desc fallback";

            document.getElementById('action-buttons').innerHTML = `
                <button class="btn-retry" onclick="startMission()"><i class="fas fa-redo"></i></button>
                <a href="${gmapSearchUrl}" target="_blank" class="btn-link fallback" style="flex:2">
                    <i class="fab fa-google"></i> ç›´æ¥æœå°‹
                </a>
            `;
            
            document.getElementById('mini-title').innerText = fallbackName;
            document.getElementById('start-area').style.display = 'none';
            document.getElementById('result-area').style.display = 'block';
        }

        function generateResult(place, type, desc, cityName) {
            const lat = parseFloat(place.lat);
            const lon = parseFloat(place.lon);
            const name = place.name || "ç¥ç§˜åœ°é»";
            const dist = (map.distance([currentLat, currentLng], [lat, lon]) / 1000).toFixed(1);

            if (targetMarker) map.removeLayer(targetMarker);
            if (routeLine) map.removeLayer(routeLine);
            if (rangeCircle) map.removeLayer(rangeCircle);

            const iconUrl = currentMode === 'normal' 
                ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png'
                : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png';

            const icon = L.icon({
                iconUrl: iconUrl,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            targetMarker = L.marker([lat, lon], {icon: icon}).addTo(map);

            const lineColor = currentMode === 'normal' ? '#11998e' : '#8e44ad';
            routeLine = L.polyline([[currentLat, currentLng], [lat, lon]], {
                color: lineColor, weight: 4, dashArray: '10, 10', opacity: 0.8
            }).addTo(map);
            map.fitBounds(routeLine.getBounds().pad(0.3));

            document.getElementById('res-tag').innerText = type;
            document.getElementById('res-tag').className = currentMode === 'normal' ? 'res-tag' : 'res-tag event';
            document.getElementById('res-dist').innerText = `è·é›¢ ${dist} km`;
            document.getElementById('res-name').innerText = name;
            document.getElementById('res-desc').innerHTML = desc;
            document.getElementById('res-desc').className = currentMode === 'normal' ? 'res-desc' : 'res-desc event';
            
            const searchContext = cityName ? `${name} ${cityName}` : name;
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(searchContext + " è©•åƒ¹ ä»‹ç´¹")}`;
            const eventSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(searchContext + " å±•è¦½ æ´»å‹• è¿‘æœŸ")}`;
            const gmapUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
            
            const finalSearchUrl = currentMode === 'normal' ? searchUrl : eventSearchUrl;
            const btnText = currentMode === 'normal' ? 'Google çœ‹çœ‹é€™æ˜¯å“ª' : 'Google æœè¿‘æœŸæ´»å‹•';

            document.getElementById('action-buttons').innerHTML = `
                <button class="btn-retry" onclick="startMission()"><i class="fas fa-redo"></i></button>
                <a href="${finalSearchUrl}" target="_blank" class="btn-search">
                    <i class="fab fa-google"></i> ${btnText}
                </a>
                <a href="${gmapUrl}" target="_blank" class="btn-link ${currentMode === 'normal'?'':'event'}">
                    <i class="fas fa-location-arrow"></i> å°èˆª
                </a>
            `;
            
            document.getElementById('mini-title').innerText = name;
            document.getElementById('start-area').style.display = 'none';
            document.getElementById('result-area').style.display = 'block';
            
            hideLoading();
        }

        function showLoading(text) {
            document.getElementById('loading-text').innerText = text;
            document.getElementById('loading').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
